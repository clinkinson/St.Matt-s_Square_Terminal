<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barista Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-zinc-900 p-6 text-white">
<h1 class="text-3xl font-bold mb-6 border-b border-zinc-700 pb-4">Incoming Drink Orders</h1>

<div id="order-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6">
</div>

<script>
    const socket = io();

    socket.on('order-update', (data) => {
        renderOrders(data.orders);
    });

    socket.on('init-data', (data) => {
        renderOrders(data.orders);
    });

    /*function renderOrders(orders) {
        const grid = document.getElementById('order-grid');
        grid.innerHTML = orders.map(order => {
            const itemCounts = {};
            order.items.forEach(item => {
                itemCounts[item] = (itemCounts[item] || 0) + 1;
            });
            
            const itemsDisplay = Object.entries(itemCounts)
                .map(([item, count]) => {
                    if (count > 1) {
                        return `<div class="text-lg font-bold mb-1">• ${item} x${count}</div>`;
                    } else {
                        return `<div class="text-lg font-bold mb-1">• ${item}</div>`;
                    }
                })
                .join('');

            return `
                <div class="bg-zinc-800 border-2 border-[#9DAE72] rounded-lg p-4 flex flex-col h-full shadow-xl">
                    <div class="text-[#9DAE72] text-xl font-black uppercase tracking-tight truncate">
                        ${order.customerName}
                    </div>

                    <button onclick="completeOrder(${order.id})" class="mt-4 bg-[#9DAE72] hover:bg-green-600 text-white font-bold py-3 rounded-md transition">
                        COMPLETE
                    </button>

                    <div class="flex-grow overflow-y-auto mt-4 border-t border-zinc-700 pt-2">
                        ${itemsDisplay}
                    </div>
                </div>
            `;
        }).join('');
    }*/
    function renderOrders(orders) {
        const grid = document.getElementById('order-grid');
        grid.innerHTML = orders.map(order => {

            const itemsDisplay = order.items.map((item, index) => {
                // Apply classes based on the 'scratched' state from the server
                const scratchClass = item.scratched ? 'scratched opacity-50' : '';
                const dotClass = item.scratched ? 'bg-[#9DAE72]' : '';

                return `
                <button onclick="toggleScratch(${order.id}, ${index})"
                    class="scratch-btn w-full text-left bg-zinc-700/30 hover:bg-zinc-700 p-3 rounded-md mb-2 border border-zinc-600 transition-all flex items-start gap-2 group ${scratchClass}">
                    <span class="mt-1.5 w-3 h-3 rounded-full border border-[#9DAE72] flex-shrink-0 ${dotClass}"></span>
                    <span class="text-lg font-medium leading-tight group-[.scratched]:line-through group-[.scratched]:text-zinc-500">
                        ${item.name}
                    </span>
                </button>
            `;
            }).join('');

            return `
            <div id="order-card-${order.id}" class="bg-zinc-800 border-2 border-[#9DAE72] rounded-lg p-4 flex flex-col h-full shadow-xl">
                <div class="text-[#9DAE72] text-xl font-black uppercase tracking-tight truncate mb-2">
                    ${order.customerName}
                </div>
                <div class="item-list flex-grow overflow-y-auto mt-2 border-t border-zinc-700 pt-4">
                    ${itemsDisplay}
                </div>
                <button onclick="completeOrder(${order.id})"
                    class="mt-4 bg-[#9DAE72] hover:bg-green-600 text-white font-bold py-3 rounded-md transition shadow-lg">
                    COMPLETE ORDER
                </button>
            </div>
        `;
        }).join('');
    }

    function toggleScratch(orderId, itemIndex) {
        socket.emit('item-scratch', { orderId, itemIndex });
    }

    function completeOrder(id) {
        socket.emit('complete-order', id);
    }
</script>
</body>
</html>